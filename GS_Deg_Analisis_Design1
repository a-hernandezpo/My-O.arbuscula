source("setup.R") #este comando permite acelerar la corrida del código inicial

## Running DESeq2 
dds<-DESeq2::DESeqDataSetFromMatrix(countData = cts, colData = coldata, design=~ Genet + SymbiontState)

#Si se cambia el orden de los factores en el diseño, los resultados de la comparación cambiarán. 
# podemos probar con: design=~SymbiontState+Genet  o  design=~SymbiontState (sin tener en cuenta el genotipo)

# pre-filtering to remove low count genes 
keep <- rowSums(counts(dds)) >= 10
dds <- dds[keep,]

ddsMF<-DESeq2::DESeq(dds) #desarrollo lit de DESeq2
resMF<-results(ddsMF) #resultados se guardan en nueva variable ("resultados Modelo Final")
resMF #DataFrame with 25428 rows and 6 columns

summary(resMF) #resume el resultado de la expresión diferencial de genes

# how many adjusted p values were less than 0.1
sum(resMF$padj<0.1, na.rm=TRUE) # 196 --> a nosotras nos da 201
# standard p value less that 0.05
sum(resMF$pvalue<0.05, na.rm=TRUE) 
conds05<-filter(as.data.frame(resMF), pvalue<0.05) # 1423 (this will be relevant for GOMWU later) --> a nosotras nos da 1453

write.table(resMF, file="Sym_vs_Apo_collapsed.txt", sep="\t", quote=F)
valState=cbind(resMF$pvalue, resMF$padj) #adjusted p values
head(valState)
colnames(valState)=c("pval.state", "padj.state")
rownames(valState)<-rownames(resMF)



# transform the data for plotting 
rlogMF=rlogTransformation(dds, blind=TRUE) 
rld=assay(rlogMF)
colnames(rld)<-paste(coldata$Genet, coldata$SymbiontState, sep="_")

rldpvals=cbind(rld,valState)
#head(rldpvals)
#dim(rldpvals)

table(complete.cases(rldpvals))

rld_data<-as.data.frame(rldpvals)
#View(rld_data)

##### Heat map of degs0 
adjpval=0.10 # FDR cutoff
conds=filter(rld_data, padj.state<adjpval)

# remove pval data 
degs=conds[,1:10]
degs$contig<-rownames(degs)
gg$contig <- gsub("isogroup", "", gg$contig)
degs<-left_join(degs, gg, by="contig") # add in genenames from annotations file
degs$genename<-sub("\\..*", "", degs$genename)
degs$genename <- sub("OS=.*$", "", degs$genename) # quitar info extra de genename
genets<-rep(c("A","B", "C", "D", "F"), 2)

degs$genename[is.na(degs$genename)]<-"unknown" #NA to "unknown"

View(degs)
dim(degs)
#Hay 201 filas y solo 60 NA.

degs$genename <- as.factor(degs$genename)
levels(degs$genename)  
#Hay 140 niveles de genename (140 genes anotados diferentes)


degs_plot<-filter(degs, genename!="unknown")
View(degs_plot)



###PLOTS###
#plotMA
results(ddsMF, contrast=c("SymbiontState", "Sym", "Apo")) # especifica el contraste que queremos hacer (Sym vs Apo)
plotMA(resMF, main="plotMA Sym vs Apo", ylim=c(-5,5)) #ver gráficamente la EDGs
png("figures/GS_MAplot_Sym_vs_Apo.png", width = 2000, height = 1800, res = 300)

#Volcano plot:
# Convertir a data frame
df_volc <- as.data.frame(resMF)
df_volc$gene <- rownames(df_volc)

# Eliminar NA en padj
df_volc <- df_volc[complete.cases(df_volc$padj), ]

# Crear columna de significancia
df_volc$threshold <- "NS"
df_volc$threshold[df_volc$padj < 0.05 & df_volc$log2FoldChange > 1] <- "Up"
df_volc$threshold[df_volc$padj < 0.05 & df_volc$log2FoldChange < -1] <- "Down"

# Volcano plot
ggplot(df_volc, aes(x = log2FoldChange, y = -log10(padj), color = threshold)) +
    geom_point(alpha = 0.6) +
    scale_color_manual(values = c("Down"="blue", "Up"="red", "NS"="grey")) +
    theme_minimal() +
    xlab("log2 Fold Change") +
    ylab("-log10 adjusted p-value") +
    ggtitle("GS_Volcano plot: Sym vs Apo")

ggsave("./figures/GS Volcano_Sym_vs_Apo.png", width = 7, height = 7, dpi = 300)

#######



source("CreatePlots.R") #llama al script para crear los gráficos.