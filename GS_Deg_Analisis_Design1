# nolint start: line_length_linter

source("setup.R") #este comando permite acelerar la corrida del código inicial

## Running DESeq2
dds<-DESeq2::DESeqDataSetFromMatrix(countData = cts, colData = coldata, design=~ Genet + SymbiontState)

#Si se cambia el orden de los factores en el diseño, los resultados de la comparación cambiarán. 
# podemos probar con: design=~SymbiontState+Genet  o  design=~SymbiontState (sin tener en cuenta el genotipo)

# pre-filtering to remove low count genes 
dim(dds) #25649
keep <- rowSums(counts(dds)) >= 10
dds <- dds[keep,]
dim(dds) #25428

ddsMF<-DESeq2::DESeq(dds) #desarrollo lit de DESeq2
resMF<-results(ddsMF) #resultados se guardan en nueva variable ("resultados Modelo Final")
resMF #DataFrame with 25428 rows and 6 columns

summary(resMF) #resume el resultado de la expresión diferencial de genes
# out of 25428 with nonzero total read count
# adjusted p-value < 0.1                   umbral de significancia que estoy usando
# LFC > 0 (up)       : 153, 0.6% Log2      Fold Change positivo (más expresión en la condición de interés vs control)
# LFC < 0 (down)     : 48, 0.19%           Log2 Fold Change negativo (menos expresión)
# outliers [1]       : 0, 0%
# low counts [2]     : 0, 0%               (mean count < 1)
# 153 UP + 48 DOWN = 201 genes significativos


# standard p value less that 0.05
sum(resMF$pvalue<0.05, na.rm=TRUE) # 1453
# how many adjusted p values were less than 0.1
sum(resMF$padj<0.05, na.rm=TRUE) # si padj<0.05 = 163       si padj<0.1 = 201
conds05<-filter(as.data.frame(resMF), pvalue<0.05) 

write.table(resMF, file="Sym_vs_Apo_collapsed.txt", sep="\t", quote=F)
valState=cbind(resMF$pvalue, resMF$padj) #adjusted p values
head(valState)
colnames(valState)=c("pval.state", "padj.state")
rownames(valState)<-rownames(resMF)



# transform the data for plotting 
rlogMF=rlogTransformation(dds, blind=TRUE) 
rld=assay(rlogMF)
colnames(rld)<-paste(coldata$Genet, coldata$SymbiontState, sep="_")

rldpvals=cbind(rld,valState)
#head(rldpvals)
#dim(rldpvals)

table(complete.cases(rldpvals))

rld_data<-as.data.frame(rldpvals)
#View(rld_data)

##### Heat map of degs0 
adjpval=0.05 # FDR cutoff
conds=filter(rld_data, padj.state<adjpval)

# remove pval data 
degs=conds[,1:10]
degs$contig<-rownames(degs)
gg$contig <- gsub("isogroup", "", gg$contig)
degs<-left_join(degs, gg, by="contig") # add in genenames from annotations file
degs$genename<-sub("\\..*", "", degs$genename)
degs$genename <- sub("OS=.*$", "", degs$genename) # quitar info extra de genename
genets<-rep(c("A","B", "C", "D", "F"), 2)

degs$genename[is.na(degs$genename)]<-"unknown" #NA to "unknown"

View(degs)
head(degs)
dim(degs)
# Si padj<0.05 Hay 163 filas y 12 NA.
# Si padj<0.1 Hay 201 filas y 60 NA.

degs$genename <- as.factor(degs$genename)
levels(degs$genename)  
# Si padj<0.05 Hay Hay 99 niveles de genename 
# Si padj<0.1 Hay 140 niveles de genename (140 genes anotados diferentes)


degs_plot<-filter(degs, genename!="unknown")



###PLOTS###

# Convertir a data frame
df_volc <- as.data.frame(resMF)
df_volc$gene <- rownames(df_volc)

# Eliminar NA en padj
df_volc <- df_volc[complete.cases(df_volc$padj), ]















#Volcano plot:

# Unir los dataframes usando merge con las columnas correctas
# df_volc$gene debe coincidir con degs$contig
df_volc <- merge(df_volc, 
                 degs[, c("contig", "genename")],
                 by.x = "gene",      # Columna en df_volc
                 by.y = "contig",    # Columna en degs
                 all.x = TRUE)       # Mantener todos los genes de df_volc

# Verificar si la unión funcionó
cat("\nVerificación de la unión:\n")
cat("Total de filas:", nrow(df_volc), "\n")
cat("Genes con genename no-NA:", sum(!is.na(df_volc$genename)), "\n") #163
cat("Genes con genename 'unknown':", sum(df_volc$genename == "unknown", na.rm = TRUE), "\n") #48















# Crear columna label: usar genename si está disponible y no es "unknown"
# Si no, usar el ID del gene
df_volc$label <- ifelse(!is.na(df_volc$genename) & 
                         df_volc$genename != "unknown",
                       df_volc$genename,
                       df_volc$gene)

# Ver algunos ejemplos
cat("\nEjemplos de labels creados:\n")
ejemplos <- df_volc %>%
  select(gene, genename, label) %>%
  head(10)
print(ejemplos)































# Crear columna de significancia
df_volc$threshold <- "NS"
df_volc$threshold[df_volc$padj < 0.1 & df_volc$log2FoldChange > 1.5] <- "Up"
df_volc$threshold[df_volc$padj < 0.1 & df_volc$log2FoldChange < -1.5] <- "Down"


## Volcano plot sencillo:
ggplot(df_volc, aes(x = log2FoldChange, y = -log10(padj), color = threshold)) +
    geom_point(alpha = 0.6) +
    scale_color_manual(values = c("Down"="blue", "Up"="red", "NS"="grey")) +
    theme_minimal() +
    xlab("log2 Fold Change") +
    ylab("-log10 adjusted p-value") +
    ggtitle("Genet + SymbiontState Volcano plot: Sym vs Apo")

ggsave("./GS figures/GS Volcano_Sym_vs_Apo.png", width = 7, height = 7, dpi = 300)

#######

## Volcano plot con TODA la información solicitada

# Contar genes en cada categoría
up_count <- sum(df_volc$threshold == "Up")
down_count <- sum(df_volc$threshold == "Down")
ns_count <- sum(df_volc$threshold == "NS")

# Preparar datos para etiquetar TODOS los genes significativos
# Genes UP (rojos) - todos
genes_up <- df_volc %>% 
  filter(threshold == "Up") %>%
  mutate(label_color = "red")

# Genes DOWN (azules) - todos
genes_down <- df_volc %>% 
  filter(threshold == "Down") %>%
  mutate(label_color = "blue")

# Combinar todos los genes significativos
genes_sig <- bind_rows(genes_up, genes_down)

# Crear el volcano plot con TODA la información
p <- ggplot(df_volc, aes(x = log2FoldChange, y = -log10(padj), color = threshold)) +
  geom_point(alpha = 0.6, size = 2) +
  scale_color_manual(
    values = c("Down" = "blue", "Up" = "red", "NS" = "grey"),
    name = "Regulación",
    labels = c(
      paste0("Down (", down_count, " genes)"),
      paste0("NS (", ns_count, " genes)"),
      paste0("Up (", up_count, " genes)")
    )
  ) +
  
  # Agregar etiquetas para TODOS los genes UP (rojos)
  geom_text_repel(
    data = genes_up,
    aes(label = gene),
    color = "darkred",
    size = 2.8,
    max.overlaps = 100,  # Aumentar para mostrar más etiquetas
    box.padding = 0.35,
    point.padding = 0.3,
    segment.color = "darkred",
    segment.alpha = 0.5,
    min.segment.length = 0.1,
    force = 2
  ) +
  
  # Agregar etiquetas para TODOS los genes DOWN (azules)
  geom_text_repel(
    data = genes_down,
    aes(label = gene),
    color = "darkblue",
    size = 2.8,
    max.overlaps = 100,
    box.padding = 0.35,
    point.padding = 0.3,
    segment.color = "darkblue",
    segment.alpha = 0.5,
    min.segment.length = 0.1,
    force = 2
  ) +
  
  # Líneas de corte
  geom_vline(xintercept = c(-1.5, 1.5), linetype = "dashed", alpha = 0.5) +
  geom_hline(yintercept = -log10(0.1), linetype = "dashed", alpha = 0.5) +
  
  # Anotaciones con conteos en el gráfico
  annotate("text", 
           x = min(df_volc$log2FoldChange) * 0.95, 
           y = max(-log10(df_volc$padj)) * 0.98,
           label = paste("DOWN:", down_count, "genes"),
           color = "blue", size = 4.5, fontface = "bold", hjust = 0) +
  
  annotate("text", 
           x = max(df_volc$log2FoldChange) * 0.95, 
           y = max(-log10(df_volc$padj)) * 0.98,
           label = paste("UP:", up_count, "genes"),
           color = "red", size = 4.5, fontface = "bold", hjust = 1) +
  
  # Título con resumen completo
  labs(
    title = "GS Volcano plot: Sym vs Apo",
    subtitle = paste("Total genes:", nrow(df_volc), 
                     "| Significativos:", up_count + down_count,
                     " (", round((up_count + down_count)/nrow(df_volc)*100, 1), "%)", sep = ""),
    x = "log2 Fold Change",
    y = "-log10 adjusted p-value"
  ) +
  
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5, margin = margin(b = 15)),
    legend.position = "bottom",
    legend.title = element_text(face = "bold"),
    panel.grid.minor = element_blank()
  ) +
  
  # Ajustar límites para mejor visualización
  scale_x_continuous(expand = expansion(mult = 0.1)) +
  scale_y_continuous(expand = expansion(mult = 0.1))

# Mostrar el gráfico
print(p)

# Guardar con alta resolución (ajustar tamaño según número de genes)
width_size <- 12 + (nrow(genes_sig) / 50)  # Ajustar ancho según número de genes
height_size <- 10 + (nrow(genes_sig) / 100)  # Ajustar alto según número de genes

ggsave("./GS figures/GS Volcano_Sym_vs_Apo_COMPLETO.png", 
       plot = p, 
       width = min(width_size, 20),  # Máximo 20 pulgadas
       height = min(height_size, 16),  # Máximo 16 pulgadas
       dpi = 300,
       bg = "white")

# Versión alternativa si hay MUCHOS genes (más de 100) - opcional
if (nrow(genes_sig) > 100) {
  cat("\n⚠️  ADVERTENCIA: Hay", nrow(genes_sig), "genes significativos.\n")
  cat("El gráfico puede estar muy congestionado. Considera:\n")
  cat("1. Aumentar el tamaño de la imagen guardada\n")
  cat("2. Mostrar solo los top 20 genes por categoría\n")
  cat("3. Exportar a PDF para mejor calidad\n")
  
  # Opción: Guardar también versión PDF para mejor escalado
  ggsave("./GS figures/GS Volcano_Sym_vs_Apo_COMPLETO.pdf", 
         plot = p, 
         width = 16, 
         height = 12,
         device = cairo_pdf)
}

# Mostrar resumen detallado en consola
cat("\n")
cat(strrep("=", 60), "\n")
cat("RESUMEN COMPLETO - Volcano Plot: Sym vs Apo\n")
cat(strrep("=", 60), "\n")
cat("Total genes analizados:", nrow(df_volc), "\n")
cat("Genes UP-regulados (rojos):", up_count, "\n")
cat("Genes DOWN-regulados (azules):", down_count, "\n")
cat("Genes no significativos (gris):", ns_count, "\n")
cat("Porcentaje significativos:", round((up_count + down_count)/nrow(df_volc)*100, 1), "%\n")

if (up_count > 0) {
  cat("\nTop 5 genes UP-regulados:\n")
  print(head(df_volc[df_volc$threshold == "Up", ] %>% 
               arrange(padj) %>% 
               select(gene, log2FoldChange, padj), 5))
}

if (down_count > 0) {
  cat("\nTop 5 genes DOWN-regulados:\n")
  print(head(df_volc[df_volc$threshold == "Down", ] %>% 
               arrange(padj) %>% 
               select(gene, log2FoldChange, padj), 5))
}
cat(strrep("=", 60) + "\n")


####



source("GS_CreatePlots.R") #llama al script para crear los gráficos.

# nolint end