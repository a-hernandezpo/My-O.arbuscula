# nolint start: line_length_linter

source("setup.R") #este comando permite acelerar la corrida del código inicial

## Running DESeq2
dds<-DESeq2::DESeqDataSetFromMatrix(countData = cts, colData = coldata, design=~ SymbiontState)

#Si se cambia el orden de los factores en el diseño, los resultados de la comparación cambiarán. 
# podemos probar con: design=~SymbiontState+Genet  o  design=~SymbiontState (sin tener en cuenta el genotipo)

# pre-filtering to remove low count genes 
dim(dds) #25649
keep <- rowSums(counts(dds)) >= 10
dds <- dds[keep,]
dim(dds) #25428

ddsMF<-DESeq2::DESeq(dds) #desarrollo lit de DESeq2
resMF<-results(ddsMF) #resultados se guardan en nueva variable ("resultados Modelo Final")
resMF #DataFrame with 25428 rows and 6 columns

# design=~ SymbiontState
summary(resMF) #resume el resultado de la expresión diferencial de genes
# out of 25428 with nonzero total read count
# adjusted p-value < 0.1
# LFC > 0 (up)       : 72, 0.28%
# LFC < 0 (down)     : 5, 0.02%
# outliers [1]       : 536, 2.1%
# low counts [2]     : 0, 0%
# (mean count < 1)
# 72 UP + 5 DOWN = 77 genes significativos

# standard p value less that 0.05
sum(resMF$pvalue<0.05, na.rm=TRUE) # 490

sum(resMF$padj<0.05, na.rm=TRUE) # si padj<0.05 = 70
conds05<-filter(as.data.frame(resMF), pvalue<0.05) 


write.table(resMF, file="SS_Sym_vs_Apo_collapsed.txt", sep="\t", quote=F)
valState=cbind(resMF$pvalue, resMF$padj) #adjusted p values
head(valState)
colnames(valState)=c("pval.state", "padj.state")
rownames(valState)<-rownames(resMF)



# transform the data for plotting 
rlogMF=rlogTransformation(dds, blind=TRUE) 
rld=assay(rlogMF)
colnames(rld)<-paste(coldata$Genet, coldata$SymbiontState, sep="_")

rldpvals=cbind(rld,valState)
table(complete.cases(rldpvals))

rld_data<-as.data.frame(rldpvals)


##### Heat map of degs0 
adjpval=0.05 # FDR cutoff
conds=filter(rld_data, padj.state<adjpval)

# remove pval data 
degs=conds[,1:10]
degs$contig<-rownames(degs)
gg$contig <- gsub("isogroup", "", gg$contig)
degs<-left_join(degs, gg, by="contig") # add in genenames from annotations file
degs$genename<-sub("\\..*", "", degs$genename)
degs$genename <- sub("OS=.*$", "", degs$genename) # quitar info extra de genename
genets<-rep(c("A","B", "C", "D", "F"), 2)

degs$genename[is.na(degs$genename)]<-"unknown" #NA to "unknown"

View(degs)
head(degs)
dim(degs)

degs$genename <- as.factor(degs$genename)
levels(degs$genename)  


degs_plot<-filter(degs, genename!="unknown")
#Para crear todos los gráficos de este script, se utiliza el siguiente comando:
#source("sS_CreatePlots.R") #llama al script para crear los gráficos.


##Gene Ontology analysis with GOWMU:

# Primero, queremos unir los resultados de DESeq2 con los términos de GO para el posterior análisis en Gene Ontology.

SS_degs_IDs <- data.frame(
    contig = degs$contig
)
View(SS_degs_IDs)
dim(SS_degs_IDs) 
AnotacionesGO <- read.delim("data/coral_gene_GOannot.tab", sep = "\t", header = FALSE)

colnames(AnotacionesGO) <- c("contig", "Terminos_GO")

SS_degs_GO <- inner_join(
    SS_degs_IDs,          # Tabla de origen (DEGs)
    AnotacionesGO,     # Tabla de destino (Anotaciones de todo el genoma)
    by = "contig"      # La columna de unión
)

dim(SS_degs_GO) # Columnas: "contig" y "Terminos_GO"
write.table(SS_degs_GO, file="SS_degs_GO.txt", sep="\t", quote=F)


# nolint end: line_length_linter